#!/bin/bash

echo "Setting up Kubernetes Goat network access..."

# Function to get pod name by label
get_pod_name() {
    local label=$1
    local namespace=${2:-default}
    kubectl get pods -n $namespace -l $label -o jsonpath='{.items[0].metadata.name}' 2>/dev/null
}

# Function to wait for pod to be ready
wait_for_pod() {
    local pod_name=$1
    local namespace=${2:-default}
    echo "Waiting for pod $pod_name to be ready..."
    kubectl wait --for=condition=ready pod/$pod_name -n $namespace --timeout=300s
}

# Function to start port forward
start_port_forward() {
    local pod_name=$1
    local local_port=$2
    local remote_port=$3
    local namespace=${4:-default}
    
    if [ ! -z "$pod_name" ]; then
        echo "Starting port forward: localhost:$local_port -> $pod_name:$remote_port"
        kubectl port-forward $pod_name --address {{ kubernetes_goat_bind_address }} -n $namespace $local_port:$remote_port > /dev/null 2>&1 &
        sleep 2
    else
        echo "Warning: Could not find pod for port $local_port"
    fi
}

echo "Finding and setting up port forwards..."

# Port 1230 - Build code (sensitive keys)
POD_NAME=$(get_pod_name "app=build-code")
if [ ! -z "$POD_NAME" ]; then
    wait_for_pod $POD_NAME
    start_port_forward $POD_NAME 1230 3000
fi

# Port 1231 - Health check (DIND)
POD_NAME=$(get_pod_name "app=health-check")
if [ ! -z "$POD_NAME" ]; then
    wait_for_pod $POD_NAME
    start_port_forward $POD_NAME 1231 80
fi

# Port 1232 - Internal proxy (SSRF)
POD_NAME=$(get_pod_name "app=internal-proxy")
if [ ! -z "$POD_NAME" ]; then
    wait_for_pod $POD_NAME
    start_port_forward $POD_NAME 1232 3000
fi

# Port 1233 - Hunger check (container escape) - in big-monolith namespace
POD_NAME=$(get_pod_name "app=hunger-check" "big-monolith")
if [ ! -z "$POD_NAME" ]; then
    wait_for_pod $POD_NAME "big-monolith"
    start_port_forward $POD_NAME 1233 8080 "big-monolith"
fi

# Port 1234 - Kubernetes Goat home
POD_NAME=$(get_pod_name "app=kubernetes-goat-home")
if [ ! -z "$POD_NAME" ]; then
    wait_for_pod $POD_NAME
    start_port_forward $POD_NAME 1234 80
fi

# Port 1235 - Poor registry
POD_NAME=$(get_pod_name "app=poor-registry")
if [ ! -z "$POD_NAME" ]; then
    wait_for_pod $POD_NAME
    start_port_forward $POD_NAME 1235 5000
fi

# Port 1236 - System monitor (DoS)
POD_NAME=$(get_pod_name "app=system-monitor")
if [ ! -z "$POD_NAME" ]; then
    wait_for_pod $POD_NAME
    start_port_forward $POD_NAME 1236 8080
fi

echo "Port forwarding setup complete!"
echo "Kubernetes Goat is accessible on:"
echo "  Main interface: http://$(hostname -I | awk '{print $1}'):1234"
echo "  Scenario ports: 1230-1236"

# Give background processes time to establish connections
sleep 5

echo "Setup finished. Port forward processes are running in background."